---
title: "Tutorial for Lecture 3 - Analysis of COVID-19 Data"
subtitle: "Scientific Data Analysis 6003ESC" 
author: "Dr. Ido Bar"
date: "02/08/2021"
output: 
    html_document:
      css: "style/style.css"
      toc: true
      toc_float: true
      toc_depth: 3
      highlight: pygments
      number_sections: false
      code_folding: hide
bibliography: style/references.bib
csl: style/springer-basic-improved-author-date-with-italic-et-al-period.csl
---

<style>
.fold-btn { float: right; }
</style>

```{js reveal-js, echo=FALSE}
$(document).ready(function() {
  $(".fold").prepend("<button class=\"fold-btn\">Reveal</button>");
  $(".fold").children("code").toggle();
  $(".fold-btn").on("click", function() {
    if($(this).text() === "Hide") {
      $(this).text("Reveal");
    } else {
      $(this).text("Hide");
    }
    $(this).next("code").toggle("linear");
  })
});
```


```{js logo-js, echo=FALSE}
$(document).ready(function() {
  $('#header').parent().prepend('<div id=\"Griffith logo\"><img src=\"https://www.griffith.edu.au/__data/assets/image/0018/653121/Griffith_Full_Logo_scaled.png\" style=\"position:absolute; top:50px; right:0; padding:20px; height:120px\"></div>');
  $('#header').css('margin-right', '120px')
});
```

```{r setup, include=FALSE}
# pacman::p_load(captioner, paletteer, highcharter, countrycode, plotly, readxl, tidyverse, here, scales, lubridate)
required_packages <- c("dplyr", "ggplot2", "paletteer", "stringr",
                       "readr","readxl", "glue",
                       "forcats", "tidyr",
                       "highcharter", "scales",  "plotly", 
                       "lubridate", "here","ISOweek", "countrycode")
# pacman::p_load(char=required_packages)
pacman::p_load(dplyr, tidyr, ggplot2, readr,  paletteer, glue, scales, plotly, lubridate, patchwork, visdat)
pacman::p_load_gh("gadenbuie/tweetrmd")
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	out.width="90%",
	fig.height = 5,
	fig.width = 8
)

# default text size in plots
def_text_size <- 12
```

## Instructions

The following tutorial will let you reproduce the plots that we are going to create at the workshop using R.  
Please read carefully and follow the steps. Wherever you see the <kbd>Code</kbd> icon on the right you can click on it to see the actual code used in that section.  

## Introduction
This tutorial will focus on analysing the updated data of the worldwide Novel Corona virus (COVID-19) pandemic.  
There are several data sources available online. We will use the data collected from a range of official sources and hosted on the [Our World in Data](https://ourworldindata.org/covid-vaccinations){target="_blank"} website [@mathieuGlobalDatabaseCOVID192021]. 

## Analyse Data in R

To run R and RStudio on Binder, click on this badge - [![Launch Rstudio Binder](http://mybinder.org/badge_logo.svg)](https://mybinder.org/v2/gh/IdoBar/6003ESC_workshops_binder/main?urlpath=rstudio){target="_blank"}.   

Start RStudio and create a new project named `Workshop3` in a new folder (if you need a reminder ho to do it, check out [Workshop1 Tutorial on BB](https://bblearn.griffith.edu.au/bbcswebdav/pid-6021408-dt-content-rid-117013314_1/xid-117013314_1){target="_blank"}).  
Once RStudio restarts inside the project's folder, create a new R script named `Workshop3.R` and 2 new folders, one named `data` for our input data and another named `output` for our plots.  

### Install Extra Packages

For this analysis we will again use some packages from the [Tidyverse](https://www.tidyverse.org/){target="_blank"}, but this time we load the specific packages (which are supposed to be pre-installed on your computers) to try and avoid having to download the entire `tidyverse`. In addition to the Tidyverse packages we've got to know in the previous workshop we will use the `plotly` package to create interactive plots, `paletteer` for custom color palettes, `readxl` to read MS-Excel file, `scales` to format large numbers, `lubridate` to better handle dates, `glue` to paste together strings, `patchwork` to include several plots in a single figure and a few others to assist in getting the data into shape.  
To install these packages, we will introduce a package called [pacman](https://trinker.github.io/pacman/){target="_blank"} that will assist in loading the required packages and installing them if they're not already installed. To install it we use the `install.packages('pacman')` command, please note that the package name need to be quoted and that we only need to perform it once, or when we want or need to update the package.  Once the package was installed, we can load its functions using the `library(pacman)` command and then load/install all the other packages at once with `p_load()` function.

```{r install_packages, eval=FALSE}
# install required packages - needed only once! (comment with a # after first use)
install.packages('pacman')
# load required packages
library(pacman)
p_load(dplyr, tidyr, ggplot2, readr,  paletteer, glue, scales, plotly, lubridate, patchwork, visdat)

```

More information on installing and using R packages can be found in this [tutorial](http://www.sthda.com/english/wiki/installing-and-using-r-packages){target="_blank"}.

### Read Data

Now that we've got RStudio up and running and our packages installed and loaded, we can read data into R from our local computer or from web locations using dedicated functions specific to the file type (`.csv`, `.txt`, `.xlsx`, etc.). 

We will use the `read_csv()` command/function from the `readr` package (part of the `tidyverse`) to load the data directly from a file on the the [Our World in Data](https://ourworldindata.org/covid-vaccinations){target="_blank"} website into a variable of type **data frame** (table). If we don't want to use external packages, we can use the `read.csv()` function from base R, which won't automatically parse columns containing dates and in previous versions of R (< 4.0) will slightly change the structure of the resulting data frame (all text columns will be converted into factors).  
> Note that in this case, we need to specify the column types because the data contains a lot of missing values that interfere with the automatic parsing of the column types._

```{r read_data}
# read data from Our World in Data website
covid_data <- read_csv("https://covid.ourworldindata.org/data/owid-covid-data.csv", 
                       col_types = paste(c("c", "f", "c", "D", rep("d", 29), 
                                           "c", rep("d", 26)), collapse = ""))

```

### Data Exploration

Let's use built-in functions for a brief data exploration, such as `head()` to show the first 10 rows of the data and `str()` for the type of data in each column:

```{r explore_data}
#explore the data frame
head(covid_data) # show first 10 rows of the data and typr of variables
str(covid_data) # show data structure

```

### Descriptive Statistics
We can also produce some descriptive statistics to better understand the data and the nature of each variable.  The `summary()` function (as can be guessed by its name) provides a quick summary of basic descriptive statistics, such as the _mean_, _min_, _max_ and quantiles for continuous numerical values.  

```{r summary}
# summary of variables in my data
summary(covid_data)
# find extreme rows
covid_data %>% arrange(desc(total_cases))
```

What are the **metadata** columns that describe our observations?
```{fold}
continent 
location  
date
```

Why do we have observations with the continent as `NA`?
```{r check_continents}
# check which location have continent as NA
covid_data %>% filter(is.na(continent)) %>% count(location)
```

```{fold}
Some rows contain summarised data of entire continents/World, we'll need to remove those
```

We can see that most of our data contains '0' (check the difference between the median and the mean in `total_cases` and `total_deaths` columns). 
Just to confirm that, let's plot a histogram of all the confirmed cases

```{r histo_numeric}
ggplot(covid_data, aes(x=total_cases)) +
  geom_histogram(fill="lightskyblue") +
  theme_bw(def_text_size)
```

The data is evolving over days (a time-series), to there's no point treating it as a random population sample.  


## Time-series plot

Let's look at confirmed cases and total deaths data for the 10 most affected countries (to date).  To find out these countries so we need to wrangle our data a little bit using the following steps:  

  a. First we remove all observations for combined continents with `filter(!is.na(continent)` 
  b. Then we group it by location with `group_by()`
  c. Then we sort it _within each location_ by date (from latest to earliest) with `arrange(desc(date))`
  d. We select just the most recent data point from each location with `slice(1)` and remove grouping with `ungroup()`
  e. Next we arrange it by descending order of total deaths and select the top 10 observations (one for each location)  
  f. Finally, we subset our original data to contain just the countries from our vector with `inner_join()`

Optional step:

  g. We can recode the `location` variable as a factor and order it so the countries will be ordered in the legend by the number of cases with 

Then we can look at the data as a table and make a plot with the number of cases in the y-axis and date in the x-axis.
```{r timeseries_cases}
# find the 10 most affected countries (to date)
latest_data <- covid_data %>% filter(!is.na(continent)) %>% 
  group_by(location) %>% arrange(desc(date)) %>% slice(1) %>% ungroup() 
most_affected_countries <- latest_data  %>%  
  arrange(desc(total_deaths)) %>% slice(1:10) %>% 
  select(location)

# subset just the data from the 10 most affected countries and order them from the most affected to the least one
most_affected_data <- covid_data %>% 
  inner_join(most_affected_countries) %>% 
  mutate(Country=factor(location, levels = most_affected_countries$location))

# create a line plot the data of total cases
ggplot(most_affected_data, aes(x=date, y=total_cases, colour=Country)) +
  geom_line(size=0.75) + scale_y_continuous(labels=comma) + 
  scale_color_paletteer_d("rcartocolor::Bold") +
  labs(color="Country", y = "Total COVID-19 cases") +
  theme_bw(def_text_size)
```

It's a bit hard to figure out how the pandemic evolved because the numbers in US, Brazil and India are an order of magnitude larger than the rest (which are very close to each other). How can we make it more visible (and also improve how of the dates appear in the x-axis)?

```{r timeseries_cases_log, warning=TRUE}

# better formatting of date axis, log scale 
plot <- ggplot(most_affected_data, aes(x=date, y=total_cases, colour=Country)) +
  geom_line(size=0.75) + scale_y_log10(labels=comma) + 
  scale_x_date(NULL,
               breaks = breaks_width("2 months"), 
               labels = label_date_short()) + 
  scale_color_paletteer_d("rcartocolor::Bold") +
  labs(color="Country", y = "Total COVID-19 cases") +
  theme_bw(def_text_size)
# show an interactive plot
ggplotly(plot)
```

Why did we get a warning message and why the graphs don't start at the bottom of the x-axis? How can we solve it? What can we infer from the graph (exponential increase)?  

```{fold}
What happens when we take the log of 0?? Can we remove those 0s with the `filter()` function (or add a very small number to them)?
We can see a very similar trend for most countries and while the curve has flattened substantially in April last year, the numbers are still rising. It is also evident that Europe got hit by a second wave arount October last year and India in April this year.
```

### Total deaths
Let's have a look at the total deaths in these countries (and get rid of the minor grid lines to make Frank happy)

```{r total_deaths}
# create a line plot the data of total deaths
ggplot(most_affected_data, aes(x=date, y=total_deaths, colour=Country)) +
  geom_line(size=0.75) + scale_y_continuous(labels=comma) + 
  scale_x_date(NULL,
               breaks = breaks_width("2 months"), 
               labels = label_date_short()) + 
  scale_color_paletteer_d("rcartocolor::Bold") +
  labs(color="Country", y = "Total deaths") +
  theme_bw(def_text_size) +  
  theme(panel.grid.minor = element_blank()) # remove minor grid lines
```

### Vaccination rates
Let's have a look at the number of vaccinated people.
```{r vaccinated}
# vaccination rates
ggplot(most_affected_data, aes(x=date, y=people_vaccinated, colour=Country)) +
  geom_line(size=0.75) + scale_y_continuous(labels=comma) + 
  scale_color_paletteer_d("rcartocolor::Bold") +
  scale_x_date(NULL,
               breaks = breaks_width("2 months"), 
               labels = label_date_short()) + 
  labs(color="Country") +
  theme_bw(def_text_size) + 
  theme(panel.grid.minor = element_blank())
```

The graphs are "broken", meaning that it is not continuous and we have some missing data.  
Let's visualise some of the variables in our data and assess "missingness".

```{r missing_data}
# visualise missingness
vis_dat(covid_data %>% filter(date>dmy("01-01-2021")) %>% 
          select(continent, location, total_cases, total_deaths, 
                 hosp_patients, people_vaccinated, people_fully_vaccinated))
                                                                 
# find which countries has the most number of observations (least missing data)
covid_data %>% filter(!is.na(continent), !is.na(people_vaccinated)) %>% # group_by(location) %>% 
  count(location) %>% arrange(desc(n)) %>% print(n=30)

covid_data %>% filter(!is.na(continent), !is.na(hosp_patients)) %>% # group_by(location) %>% 
  count(location) %>% arrange(desc(n)) %>% print(n=30)
```

### Hospitalisation and Vaccination rates
Now we can focus on a subset of countries that have more complete vaccination and hospitalisation rates data, so we could compare them.
```{r subset_countries}
countries_subset <- c("Italy", "United States", "Israel", "United Kingdom",  "France", "Czechia")
# subset our original data to these countries
hosp_data <- covid_data %>% filter(location %in% countries_subset)
# define a new colour palette for these countries
col_pal <- "ggsci::category10_d3"
```

Let's look at hospitalisation rates first.
```{r hosp}
ggplot(hosp_data, aes(x=date, y = hosp_patients,colour=location)) +
  geom_line(size=0.75) + scale_y_continuous(labels=comma) + 
  scale_color_paletteer_d(col_pal) +
  scale_x_date(name = NULL,
               breaks = breaks_width("2 months"), 
               labels = label_date_short()) + 
  labs(color="Country", y = "Hospitalised patients") +
  theme_bw(def_text_size) + 
  theme(panel.grid.minor = element_blank())
```

Can you identify the "waves" in each country?  
It's hard to see the details in the countries with lower number of hospitalised patients, how can we improve the visualisation?
```{fold}
Look at hospitalision rates proportional to the population size!
```

```{r hosp_rates}
# hosp per population size
p1 <- ggplot(hosp_data, 
       aes(x=date, y = hosp_patients_per_million,colour=location)) +
  geom_line(size=0.75) + 
  scale_y_continuous(labels=comma) + 
  scale_color_paletteer_d(col_pal) +
  scale_x_date(name = NULL,
               breaks = breaks_width("2 months"), 
               labels = label_date_short()) + 
  labs(color="Country", y = "Hospitalised patients (per million)") +
  theme_bw(def_text_size) + 
  theme(panel.grid.minor = element_blank())
p1
```

Now let's try to compare this to vaccination rates

```{r vacc_rates}
# total vaccination per population
p2 <- ggplot(hosp_data, 
             aes(x=date, y = people_fully_vaccinated_per_hundred ,colour=location)) +
  geom_line(size=0.75, linetype="dashed") + 
  guides(color = guide_legend(override.aes = list(linetype="solid") ) ) +
  scale_y_continuous(labels=comma) + 
  scale_color_paletteer_d(col_pal) +
  scale_x_date(name = NULL,
               breaks = breaks_width("2 months"), 
               labels = label_date_short()) + 
  labs(color="Country", y = "Fully vaccinated (per hundred)") +
  theme_bw(def_text_size) + 
  theme(panel.grid.minor = element_blank())
p2
```

What will be the best way to compare these values?
```{r compare_hosp_vacc}
(p1 + guides(color=FALSE))+ p2 + plot_layout(guides = 'collect')# show graphs side by side
```

Maybe like this:
```{r compare2}
(p1 + guides(color=FALSE)) / (p2 + theme(legend.position = "bottom")) #+ plot_layout(guides = 'collect')# show graphs on top of each other
```

Any suggestions?
```{fold}
There's a lot of empty "real estate" in the vaccination graph, maybe we could trim off 2020?
```

```{r compare3}
p3 <- ggplot(hosp_data, 
             aes(x=date, y = people_fully_vaccinated_per_hundred ,colour=location)) +
  geom_line(size=0.75, linetype="dashed") +
  guides(color = guide_legend(override.aes = list(linetype="solid") ) ) +
  scale_y_continuous(labels=comma) + 
  scale_color_paletteer_d(col_pal) +
  scale_x_date(name = NULL,
               limits = c(dmy("01-01-2021"), NA),
               breaks = breaks_width("2 months"), 
               labels = label_date_short()) + 
  labs(color="Country", y = "Fully vaccinated (per hundred)") +
  theme_bw(def_text_size) + 
  theme(panel.grid.minor = element_blank())
(p1 + guides(color=FALSE)) + p3 + plot_layout(guides = 'collect', widths = c(2, 1)) # maybe like this?
```

Let's try to present them on the same graph (note the trick with the secondary y-axis).

```{r secondary_y}
# show on the same graph
p4 <- ggplot(hosp_data, 
       aes(x=date, colour=location)) +
  geom_line(aes(y = hosp_patients_per_million), size=0.75) + 
  geom_line(aes(y = people_fully_vaccinated_per_hundred*10), size=0.75, linetype="dashed") + 
  scale_y_continuous(labels=comma, name = "Hospitalised patients per million (solid)",
                     # Add a second axis and specify its features
                     sec.axis = sec_axis(trans=~./10,  name="Fully vaccinated per hundred (dashed)")) + 
  scale_color_paletteer_d(col_pal) +
  scale_x_date(NULL,
               breaks = breaks_width("2 months"), 
               labels = label_date_short()) + 
  labs(color="Country") +
  theme_bw(def_text_size) + 
  theme(panel.grid.minor = element_blank()) 
p4
```

Probably best to present them on the same graph (note the trick with the secondary y-axis), but for each country separately (done with the `facet_wrap()` function).

```{r secondary_y_facet}
# show on the same graph, but separate each country
p4 + 
  scale_x_date(NULL,
               breaks = breaks_width("4 months"), 
               labels = label_date_short()) +
  facet_wrap(~location)
```

Anything to worry about???

Save the plot to a folder.
```{r save_plot, eval=FALSE}
# create output folder
dir.create("./output", showWarnings = FALSE)
# save the plot to pdf file
ggsave("output/hospit_vacc_rates_facet_country.pdf", width=14, height = 8)
```


#### Questions
1. What other variables we could analyse? 
2. Any correlated variables?
2. What we should take into account that might bias the results or the true status of the pandemic?

```{fold}
1. Mortalities (Case Fatality Rate)?  
2. Suggestions? (cases per population density, vaccination rates by country income, deaths by number of beds per capita, etc.
3. Level of reporting in each country...  
```


## Additional Resources

* **Johns Hopkins University Center for Systems Science and Engineering** (JHU CSSE) [data repository](https://github.com/CSSEGISandData/COVID-19){target="_blank"} and [website](https://systems.jhu.edu/research/public-health/ncov/){target="_blank"}
* **EU 14-days COVID-19 data** for download in CSV/Excel format [link](https://www.ecdc.europa.eu/en/publications-data/data-national-14-day-notification-rate-covid-19){target="_blank"} 
* **Be awesome in ggplot2: A Practical Guide to be Highly Effective** -- R software and data visualization ([link](http://www.sthda.com/english/wiki/be-awesome-in-ggplot2-a-practical-guide-to-be-highly-effective-r-software-and-data-visualization){target="_blank"})  
* **The R graph gallery** - From the creator of "Data to Viz" - a comprehensive gallery of R charts, with reproducible code examples ([link](https://www.r-graph-gallery.com/index.html){target="_blank"})
* **COVID-19 vaccination data** in [Our World in Data site](https://ourworldindata.org/covid-vaccinations){target="_blank"}
* My very own [COVID-19 dashboard](https://idobar.github.io/covid19-dash/){target="_blank"} (created in R, needs updating)

## Contact 

Please contact me at [i.bar\@griffith.edu.au](mailto:i.bar@griffith.edu.au?subject=[6003ESC]%20Workshop3%20question) for any questions or comments.

## References